name: Cancel Stuck jobs. Run CheckInTest on Multiple Runners and Upload Logs

on:
  push:
    branches:
      - user/jdugar/TestSelfHostAgent

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  test:
    name: Run on ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ASUS-PROART
            label: Asus-ProArt
          - name: MICROSOFT-SURFA
            label: Surface-Pro
          - name: HP-REGIS-PV
            label: HP-REGIS-PV
    runs-on: ${{ matrix.label }}

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pywinauto
        shell: powershell

      - name: Run PowerShell Tests from E2E folder (device ${{ matrix.name }})
        shell: powershell
        continue-on-error: true
        working-directory: E2E
        run: |
          try {
              .\CheckInTest.ps1
            } catch {
              Write-Error "Test failed: $_"
              exit 1
            }

      - name: Find the latest log folder
        if: always()
        id: find-latest-log
        shell: powershell
        working-directory: E2E\logs
        run: |
          Write-Output "Changed directory to: $PWD"
          $logFolders = Get-ChildItem -Directory
          Write-Output "Log folders found: $($logFolders.Name)"
          $latestLogFolder = $logFolders | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          Write-Output "Latest log folder: $latestLogFolder"
          echo "LOG_FOLDER_NAME=$latestLogFolder" >> $env:GITHUB_ENV
          echo "LATEST_LOG_FOLDER=$($latestLogFolder.FullName)" >> $env:GITHUB_ENV

      - name: Verify latest log folder contents
        shell: powershell
        run: |
          Get-ChildItem -Path "${{ env.LATEST_LOG_FOLDER }}" -Recurse

      - name: Set artifact name
        id: set-artifact-name
        shell: powershell
        run: |
          $artifactName = "${{ env.LOG_FOLDER_NAME }}-${{ matrix.name}}"
          echo "ARTIFACT_NAME=$artifactName" >> $env:GITHUB_ENV

      - name: Upload logs from device ${{ matrix.name }}
        if: ${{ always() && env.LATEST_LOG_FOLDER != '' }}
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.LATEST_LOG_FOLDER }}\**
          if-no-files-found: warn
          retention-days: 7
          compression-level: 6
          overwrite: true
          include-hidden-files: false

      - name: Test Complete on device ${{ matrix.name }}
        if: success()
        run: |
          Write-Output "Test run completed successfully"

      - name: Test Failed on device ${{ matrix.name }}
        if: failure()
        run: |
          Write-Output "Test run failed"

  controller:
    name: Cancel Stuck Jobs After 10min
    runs-on: windows-latest
    continue-on-error: true
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Delay before checking status
        run: sleep 180

      - name: Cancel stuck jobs
        shell: powershell
        run: |
          # Ensure GH_TOKEN is available
          if (-not $env:GH_TOKEN) {
            Write-Error "Error: GH_TOKEN is not set."
            exit 1
          }

          # Fetch the latest run ID
          $runId = gh run list --repo microsoft/WSEAutomationTests --limit 1 --json databaseId --jq '.[0].databaseId'
          if (-not $runId) {
            Write-Error "Failed to fetch run ID"
            exit 1
          }
          Write-Output "Run ID: $runId"

          # Fetch job details
          $jobsJson = gh api --method GET `
            -H "Authorization: token $env:GH_TOKEN" `
            -H "Accept: application/vnd.github+json" `
            "/repos/microsoft/WSEAutomationTests/actions/runs/$runId/jobs"

          if (-not $jobsJson) {
            Write-Error "Failed to fetch job details"
            exit 1
          }
  
          # Parse and cancel stuck jobs
          $jobs = $jobsJson | ConvertFrom-Json
          foreach ($job in $jobs.jobs) {
            $name = $job.name
            $status = $job.status
            $id = $job.id

            if ($name -like "*Run on*" -and $status -eq "queued") {
              Write-Output "Cancelling stuck job: $name with ID $id"
              $cancelResponse = gh api --method POST `
                  -H "Authorization: token $env:GH_TOKEN" `
                  "/repos/microsoft/WSEAutomationTests/actions/jobs/$id/cancel" 2>&1

              if ($cancelResponse -like "*Not Found*") {
                  Write-Warning "Failed to cancel job $name with ID $id: Not Found"
              } else {
                  Write-Output "Successfully cancelled job $name with ID $id"
              }
          }
          }
    
