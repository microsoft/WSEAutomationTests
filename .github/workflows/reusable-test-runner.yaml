name: Run Tests on Self-Hosted Runner

on:
  workflow_call:
    inputs:
      runner_label:
        required: true
        type: string
      device_name:
        required: true
        type: string

jobs:
  run-tests:
    name: Run tests on ${{ inputs.device_name }}
    runs-on: ${{ inputs.runner_label }}
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pywinauto
        shell: powershell    

      - name: Run PowerShell Tests
        shell: powershell
        working-directory: E2E
        run: |
          try {
              # Run the script and capture all output
              $testOutput = .\CheckInTest.ps1 *>&1 | Tee-Object -Variable out

              # Check for any test failure in output
              if ($out -match ":\s*Failed") {
                  Write-Error "One or more tests failed."
                  exit 1
              }

              # Optional: output full logs to console
              $out | ForEach-Object { Write-Host $_ }

          } catch {
              Write-Error "Test script threw an exception: $_"
              exit 1
          }

      - name: Find the latest log folder
        if: always()
        id: find-latest-log
        shell: powershell
        working-directory: E2E\logs
        run: |
          Write-Output "Changed directory to: $PWD"
          $logFolders = Get-ChildItem -Directory
          Write-Output "Log folders found: $($logFolders.Name)"
          $latestLogFolder = $logFolders | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          Write-Output "Latest log folder: $latestLogFolder"
          echo "LOG_FOLDER_NAME=$latestLogFolder" >> $env:GITHUB_ENV
          echo "LATEST_LOG_FOLDER=$($latestLogFolder.FullName)" >> $env:GITHUB_ENV

      - name: Verify latest log folder contents
        shell: powershell
        run: |
          Get-ChildItem -Path "${{ env.LATEST_LOG_FOLDER }}" -Recurse

      - name: Set artifact name
        id: set-artifact-name
        shell: powershell
        run: |
          $artifactName = "${{ env.LOG_FOLDER_NAME }}-${{ inputs.device_name  }}"
          echo "ARTIFACT_NAME=$artifactName" >> $env:GITHUB_ENV

      - name: Upload logs from device ${{ inputs.device_name  }}
        if: ${{ always() && env.LATEST_LOG_FOLDER != '' }}
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.LATEST_LOG_FOLDER }}\**
          if-no-files-found: warn
          retention-days: 7
          compression-level: 6
          overwrite: true
          include-hidden-files: false

      - name: Test Complete on device ${{ inputs.device_name  }}
        if: success()
        run: Write-Output "Test run completed successfully"

      - name: Test Failed on device ${{ inputs.device_name  }}
        if: failure()
        run: Write-Output "Test run failed"